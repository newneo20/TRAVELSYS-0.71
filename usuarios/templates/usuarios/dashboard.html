{% extends 'base.html' %}
{% load static %}

{% block title %}Panel de Control - TravelSYS{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">

<div class="container-fluid">
    <div class="row">
        <!-- Contenido Principal -->
        <main class="col-md-12 px-md-4">
            <!-- Encabezado -->
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Dashboard</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="dateRange" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="far fa-calendar-alt"></i>
                            {{ selected_range|default:"Este mes" }}
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dateRange">
                            <li><a class="dropdown-item" href="?range=hoy">Hoy</a></li>
                            <li><a class="dropdown-item" href="?range=7_dias">Últimos 7 días</a></li>
                            <li><a class="dropdown-item" href="?range=30_dias">Últimos 30 días</a></li>
                            <li><a class="dropdown-item" href="?range=mes">Este mes</a></li>
                            <li><a class="dropdown-item" href="?range=ano">Este año</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 
            Barra de búsqueda
            <div class="mb-3">
                <input type="text" class="form-control" id="searchDashboard" placeholder="Buscar en el dashboard...">
            </div>

            Centro de Notificaciones
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <strong>¡Nuevas actualizaciones!</strong> Se han agregado nuevas funcionalidades al sistema.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            -->



            <!-- Acciones Rápidas -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <h5>Acciones Rápidas</h5>                   
                    <a href="{% url 'backoffice:crear_hotel' %}" class="btn btn-secondary me-2">
                        <i class="fas fa-hotel"></i> Agregar Hotel
                    </a>
                    <a href="{% url 'crear_usuario' %}" class="btn btn-info me-2">
                        <i class="fas fa-user-plus"></i> Nuevo Usuario
                    </a>
                    <a href="#" class="btn btn-success">
                        <i class="fas fa-file-invoice-dollar"></i> Generar Reporte
                    </a>
                </div>
            </div>

            <!-- Tarjetas de Resumen -->
            <div class="row">
                <!-- Primera fila de tarjetas -->
                <div class="col-md-3 mb-3">
                    <a href="{% url 'backoffice:listar_reservas' %}" class="text-decoration-none">
                        <div class="card text-white bg-warning h-100">
                            <div class="card-body position-relative">
                                <div class="card-body-icon">
                                    <i class="fas fa-clipboard-list"></i>
                                </div>
                                <h5 class="card-title">Total de Reservas</h5>
                                <h3 class="card-text">{{ reservas|length }}</h3>
                            </div>
                        </div>
                    </a>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="card text-white bg-primary h-100">
                        <div class="card-body position-relative">
                            <div class="card-body-icon">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <h5 class="card-title">Reservas Activas</h5>
                            <h3 class="card-text">{{ reservas_activas|length }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-white bg-success h-100">
                        <div class="card-body position-relative">
                            <div class="card-body-icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <h5 class="card-title">Ingresos Totales</h5>
                            <h3 class="card-text">${{ ingresos_totales|floatformat:2 }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-white bg-danger h-100">
                        <div class="card-body position-relative">
                            <div class="card-body-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h5 class="card-title">Gastos Totales</h5>
                            <h3 class="card-text">${{ gastos_totales|floatformat:2 }}</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Segunda fila de tarjetas --> 
            <div class="row">
                <div class="col-md-3 mb-3">
                    <a href="{% url 'listar_usuarios' %}" class="text-decoration-none">
                        <div class="card text-white bg-info h-100">
                            <div class="card-body position-relative">
                                <div class="card-body-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <h5 class="card-title">Usuarios</h5>
                                <h3 class="card-text">{{ usuarios|length }}</h3>
                            </div>
                        </div>
                    </a>
                </div>
                
                <div class="col-md-3 mb-3">
                    <a href="{% url 'backoffice:listar_hoteles' %}" class="text-decoration-none">
                        <div class="card text-white bg-secondary h-100">
                            <div class="card-body position-relative">
                                <div class="card-body-icon">
                                    <i class="fas fa-hotel"></i>
                                </div>
                                <h5 class="card-title">Total de Hoteles</h5>
                                <h3 class="card-text">{{ hoteles|length }}</h3>
                            </div>
                        </div>
                    </a>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="card text-white bg-dark h-100">
                        <div class="card-body position-relative">
                            <div class="card-body-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <h5 class="card-title">Promedio Reserva</h5>
                            <h3 class="card-text">${{ avg_reservation_value|floatformat:2 }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-white bg-purple h-100">
                        <div class="card-body position-relative">
                            <div class="card-body-icon">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <h5 class="card-title">Tasa de Ocupación</h5>
                            <h3 class="card-text">{{ tasa_ocupacion|floatformat:2 }}%</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Métricas de Rendimiento (KPIs) -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <h2>Métricas de Rendimiento (KPIs)</h2>
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Métrica</th>
                                    <th>Valor Actual</th>
                                    <th>Objetivo</th>
                                    <th>Progreso</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Tasa de Conversión</td>
                                    <td>3.5%</td>
                                    <td>5%</td>
                                    <td>
                                        <div class="progress">
                                            <div class="progress-bar" role="progressbar" style="width: 70%;" aria-valuenow="70" aria-valuemin="0" aria-valuemax="100">70%</div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Satisfacción del Cliente</td>
                                    <td>4.2/5</td>
                                    <td>4.5/5</td>
                                    <td>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: 84%;" aria-valuenow="84" aria-valuemin="0" aria-valuemax="100">84%</div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Tiempo Promedio de Reserva</td>
                                    <td>{{ tiempo_promedio_reserva|floatformat:2 }} días</td>
                                    <td>3 días</td>
                                    <td>
                                        <div class="progress">
                                            <div class="progress-bar bg-warning" role="progressbar" style="width: {{ tiempo_promedio_reserva|floatformat:2 }}%;" 
                                                 aria-valuenow="{{ tiempo_promedio_reserva|floatformat:2 }}" aria-valuemin="0" aria-valuemax="100">
                                                {{ tiempo_promedio_reserva|floatformat:2 }}%
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Top 5 Agencias -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <h2>Top 5 Agencias por Reservas y Ingresos</h2>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead>
                                <tr>
                                    <th class="text-center align-middle">Agencia</th>
                                    <th class="text-center align-middle">Número de Reservas</th>
                                    <th class="text-center align-middle">Ingresos Generados</th>
                                    <th class="text-center align-middle">Porcentaje del Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for agencia in top_agencias %}
                                <tr>
                                    <!-- Nombre de la agencia -->
                                    <td class="text-center align-middle">{{ agencia.agencia }}</td>
                                    
                                    <!-- Total de reservas -->
                                    <td class="text-center align-middle">{{ agencia.total_reservas }}</td>
                                    
                                    <!-- Ingresos (si no es aplicable, puedes quitar esta columna o ajustarla) -->
                                    <td class="text-center align-middle">${{ agencia.ingresos|default:"0.00"|floatformat:2 }}</td>
                                    
                                    <!-- Porcentaje de reservas (puede calcularse en la vista si no está incluido en la función) -->
                                    <td class="text-center align-middle">                                        
                                        <div class="progress" style="height: 20px; width: 100%;">
                                            <div class="progress-bar bg-primary" role="progressbar" 
                                                 style="width: {{ agencia.porcentaje|default:"0" }}%; height: 20px;">
                                                {{ agencia.porcentaje|default:"0"|floatformat:1 }}%
                                            </div>
                                        </div>
                                    </td>
                                    
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center">No hay datos disponibles.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            
                        </table>
                    </div>
                </div>
            </div>

            <!-- Sección de Reservas en Alerta de Pago y Alerta de Cobro -->
            <div class="row mt-4">
                <!-- Reservas en Alerta de Pago -->
                <div class="col-md-6">
                    <h2 class="text-danger">Reservas en Alerta de Pago</h2>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Hotel</th>
                                    <th>Cliente</th>
                                    <th>Fecha Check-in</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reserva in reservas_alerta_pago %}
                                <tr>
                                    <td>{{ reserva.hotel.hotel_nombre }}</td>
                                    <td>{{ reserva.nombre_usuario }}</td>
                                    <td>{{ reserva.habitaciones_reserva.first.fechas_viaje|slice:":10" }}</td>
                                    <td>{{ reserva.estatus }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center">No hay reservas en alerta de pago.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Reservas en Alerta de Cobro -->
                <div class="col-md-6">
                    <h2 class="text-warning">Reservas en Alerta de Cobro</h2>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Hotel</th>
                                    <th>Cliente</th>
                                    <th>Fecha Check-in</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reserva in reservas_alerta_cobro %}
                                <tr>
                                    <td>{{ reserva.hotel.hotel_nombre }}</td>
                                    <td>{{ reserva.nombre_usuario }}</td>
                                    <td>{{ reserva.habitaciones_reserva.first.fechas_viaje|slice:":10" }}</td>
                                    <td>{{ reserva.estatus }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center">No hay reservas en alerta de cobro.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Gráficos -->
            <div class="row mt-4">
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-line me-2"></i>Reservas Mensuales (Último Año)</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="reservasMensualesChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-bar me-2"></i>Ingresos y Gastos (Último Año)</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="ingresosGastosChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top 5 Hoteles -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <h2>Top 5 Hoteles por Reservas</h2>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead>
                                <tr>
                                    <th class="text-center align-middle">Hotel</th>
                                    <th class="text-center align-middle">Número de Reservas</th>
                                    <th class="text-center align-middle">Calificación Promedio</th>
                                    <th class="text-center align-middle">Ocupación</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for hotel in top_hoteles %}
                                <tr>
                                    <td class="text-center align-middle">{{ hotel.hotel_nombre }}</td>
                                    <td class="text-center align-middle">{{ hotel.num_reservas }}</td>
                                    <td class="text-center align-middle">
                                        <div class="star-rating" aria-label="Calificación: {{ hotel.calificacion_promedio }} de 5 estrellas">
                                            {% for i in "12345"|make_list %}
                                                {% if forloop.counter <= hotel.calificacion_promedio %}
                                                    <i class="fas fa-star text-warning"></i>
                                                {% else %}
                                                    <i class="far fa-star text-warning"></i>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </td>
                                    <td class="text-center align-middle">
                                        <div class="progress">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ hotel.ocupacion }}%;" aria-valuenow="{{ hotel.ocupacion }}" aria-valuemin="0" aria-valuemax="100">{{ hotel.ocupacion }}%</div>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center">No hay datos disponibles.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Usuarios Recientes -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <h2>Nuevos Usuarios Registrados</h2>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead>
                                <tr>
                                    <th class="text-center align-middle">Nombre</th>
                                    <th class="text-center align-middle">Email</th>
                                    <th class="text-center align-middle">Fecha de Registro</th>
                                    <th class="text-center align-middle">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for usuario in ultimos_usuarios %}
                                <tr>
                                    <td class="text-center align-middle">{{ usuario.agencia }}</td>
                                    <td class="text-center align-middle">{{ usuario.email }}</td>
                                    <td class="text-center align-middle">{{ usuario.date_joined|date:"d/m/Y H:i" }}</td>
                                    <td class="text-center align-middle">
                                        <a href="{% url 'editar_usuario' usuario_id=usuario.id %}"class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" data-bs-placement="top" title="Ver perfil">
                                            <i class="fas fa-user"></i>
                                        </a> 
                                        <a href="#"class="btn btn-sm btn-outline-secondary" data-bs-toggle="tooltip" data-bs-placement="top" title="Enviar Mensaje (en desarrollo)">
                                            <i class="fas fa-envelope"></i>
                                        </a>     
                                    </td>
                                </tr>
                                {% empty %}
                                <tr class="text-center align-middle">
                                    <td colspan="4" class="text-center">No hay nuevos usuarios.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>
</div>

<!-- JavaScript para los gráficos y funcionalidades adicionales -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Gráfico de Reservas Mensuales
        const ctxReservas = document.getElementById('reservasMensualesChart').getContext('2d');
        new Chart(ctxReservas, {
            type: 'line',
            data: {
                labels: {{ labels_meses|safe }},
                datasets: [{
                    label: 'Reservas',
                    data: {{ datos_reservas_mensuales|safe }},
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    borderColor: 'rgba(13, 110, 253, 1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Reservas: ${context.parsed.y}`;
                            }
                        }
                    }
                },
                scales: {
                    x: { grid: { display: false } },
                    y: { beginAtZero: true }
                }
            }
        });

        // Gráfico de Ingresos y Gastos
        const ctxIngresosGastos = document.getElementById('ingresosGastosChart').getContext('2d');
        new Chart(ctxIngresosGastos, {
            type: 'bar',
            data: {
                labels: {{ labels_meses|safe }},
                datasets: [
                    {
                        label: 'Ingresos',
                        data: {{ datos_ingresos|safe }},
                        backgroundColor: 'rgba(25, 135, 84, 0.7)', // Verde
                        borderColor: 'rgba(25, 135, 84, 1)',
                        borderWidth: 1,
                    },
                    {
                        label: 'Gastos',
                        data: {{ datos_gastos|safe }},
                        backgroundColor: 'rgba(220, 53, 69, 0.7)', // Rojo
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 1,
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        stacked: false, // Esto permite que las barras estén lado a lado
                    },
                    y: {
                        beginAtZero: true,
                        stacked: false, // Esto evita que los valores de las barras se acumulen
                        ticks: {
                            callback: function(value) {
                                return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(value);
                            }
                        }
                    }
                }
            }
        });


        // Inicializar tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        // Funcionalidad de búsqueda
        document.getElementById('searchDashboard').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('table tbody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
    });
</script>
{% endblock %}